# PostgreSQL 인증 문제 해결 요약 보고서

## 1. 문제 개요 및 현상 재현

- **증상 요약:** Node.js 백엔드(Prisma ORM 사용)가 PostgreSQL 데이터베이스에 연결하지 못하는 문제가 발생했습니다. Prisma를 통해 DB 연결 시도 시 인증 오류가 발생하지만, 동일한 자격 증명을 사용하는 **pgAdmin** 툴로는 정상 접속이 가능합니다.
- **오류 메시지 예시:** Prisma 클라이언트 실행 시 `P1000: Authentication failed...` 오류가 나타나며, PostgreSQL 로그에는 `FATAL: password authentication failed for user ...`가 기록됩니다.
- **현상 재현:** 환경 변수로 설정된 DB 연결 문자열로 `npx prisma db pull` 또는 서버를 실행하면 인증 실패가 발생하지만, pgAdmin에서 동일한 사용자/비밀번호로 접속하면 성공함을 확인할 수 있습니다.

## 2. 시스템 아키텍처 및 DB 연동

- **플랫폼 구조:** AI‑GO 플랫폼은 Next.js 프론트엔드와 Node.js(Prisma ORM) 백엔드로 구성되며, 운영 DB로 PostgreSQL(및 TimescaleDB 확장)을 사용합니다【10†L13-L22】. 개발 환경은 SQLite를 사용하지만 배포 환경에서 PostgreSQL로 전환됩니다.
- **DB 연결:** 애플리케이션은 `.env`의 `DATABASE_URL` 문자열을 이용해 DB 풀을 초기화합니다. 실시간 모니터링 모듈과 백업 서비스가 모두 DB와 연동되어 데이터 수집 및 캐싱에 사용합니다【18†L48-L57】.

## 3. Prisma/Node.js 인증 실패 원인 분석

pgAdmin에서는 접속이 가능하지만 Prisma에서는 인증 오류가 발생하는 원인은 다음과 같이 정리할 수 있습니다:

1. **환경 변수 오류:** `.env` 파일에 잘못된 사용자명/비밀번호 또는 공백·따옴표 포맷 오류가 있어 Prisma가 올바른 정보를 받지 못했을 가능성이 높습니다. pgAdmin에서는 직접 올바른 값을 입력했기에 성공할 수 있습니다.
2. **pg_hba.conf 설정:** PostgreSQL의 호스트 기반 인증(pg_hba.conf) 규칙이 애플리케이션 서버 IP를 허용하지 않아 거부되었을 수 있습니다. 로컬 접속은 허용되고 외부 접속은 불허한 경우 해당 규칙에 적용됩니다. pgAdmin은 DB와 동일 호스트에서 접속해 통과되었을 수 있습니다.
3. **SSL 설정:** 클라우드 DB가 SSL 접속을 강제하지만 Prisma 연결 문자열에 `sslmode=require` 등이 누락되어 비SSL 접속을 시도한 경우입니다. pgAdmin은 UI로 SSL 설정을 자동 적용했을 수 있습니다.
4. **DB 사용자 권한:** Prisma가 사용하는 전용 계정에 비밀번호가 설정되지 않았거나, 계정이 잠겨 있는 경우입니다. pgAdmin은 관리자 계정으로 접속해 문제를 감지하지 못했을 수 있습니다.

이러한 차이점은 **환경 설정과 접속 경로 불일치**에서 비롯되며, DB 자체는 정상이나 Node 애플리케이션 쪽 설정 미스가 주 원인임을 시사합니다.

## 4. 영향 분석

- **실시간 모니터링 중단:** DB 인증 실패로 Prisma를 통해 실시간 지표를 읽지 못해 대시보드의 지표가 멈추거나 오래된 캐시 데이터로 표시되었습니다.
- **폴백 데이터 사용:** 일부 구성에서는 DB 장애 시 GitHub의 정적 JSON 데이터로 자동 폴백했으나, 데이터 최신성이 떨어지고 모델 수 누락 등 부정확한 정보가 표시되었습니다【20†L13-L21】.
- **정기 백업 실패:** DB 접속에 실패함으로써 백업 스크립트가 실행되지 못해 해당 기간의 데이터 백업이 누락될 위험이 있습니다.
- **오류 로그 및 자원 낭비:** Prisma의 재시도 로직으로 애플리케이션 로그에 오류가 다량 기록되고, 재시도로 인한 자원 낭비가 발생했습니다.

## 5. 해결 방안

### 즉시 대응 (24시간 내)

1. **환경 변수 검증:** `.env`의 `DATABASE_URL`, `POSTGRES_USER`, `POSTGRES_PASSWORD` 값을 다시 확인하고 불필요한 공백, 따옴표 오류를 제거합니다.
2. **DB 계정 비밀번호 재설정:** PostgreSQL에 접속하여 애플리케이션용 계정 비밀번호를 재설정하고 적절한 권한을 부여합니다. 예: `ALTER USER aigo_app WITH PASSWORD 'NewStrongPass';`.
3. **pg_hba.conf 임시 수정:** 애플리케이션 서버 IP 대역에 대해 `md5` 인증을 허용하도록 규칙을 추가하고 이후 보안 범위를 좁혀 적용합니다.
4. **SSL 설정 적용:** 클라우드 DB라면 Prisma의 연결 문자열에 `?sslmode=require`를 추가하여 SSL 접속을 강제합니다.
5. **모니터링 폴백 모드 설정:** 문제 해결 전까지는 모니터링 서비스를 폴백 데이터 소스로 전환하거나 일시 중단하여 오류 폭주를 방지합니다.

### 단기 개선 (1주 이내)

1. **pg_hba.conf 안전 재구성:** 임시로 열어두었던 범용 규칙을 삭제하고 애플리케이션 서버 범위만 허용하도록 안전하게 구성합니다.
2. **환경 일관성 확보:** 개발·스테이징 환경에서도 PostgreSQL을 사용해 인증 과정을 동일하게 테스트하며, 환경 변수 검증 스크립트를 도입합니다.
3. **자격 정보 관리 강화:** DB 자격 증명을 배포 플랫폼의 시크릿 관리 기능으로 이동시키고 배포 시 인증 테스트가 실패하면 중단하도록 파이프라인을 수정합니다【23†L69-L71】.
4. **자동 폴백 개선:** Prisma 연결이 연속 실패할 경우 GitHub TempData와 같은 폴백 데이터를 자동으로 사용하도록 로직을 개선합니다.
5. **데이터 동기화 작업:** 장애 기간 동안 폴백 데이터와 실제 DB 데이터의 차이를 확인하고 복구 후 일관성을 맞춥니다.

### 중기 개선 (1~3개월)

1. **CI/CD에 DB 연결 테스트 추가:** 배포 파이프라인에서 DB 연결 건강 검사를 자동으로 수행하고 실패 시 배포를 차단합니다.
2. **스테이징 환경 구축:** 운영과 동일한 PostgreSQL 환경을 가진 스테이징을 마련해 SSL/pg_hba 설정, 계정 권한을 사전 검증합니다.
3. **IaC 통한 DB 설정 자동화:** PostgreSQL 사용자 생성 및 권한 부여, `pg_hba.conf` 설정을 Terraform/Ansible 등으로 자동화하여 구성 실수를 방지합니다.
4. **모니터링 및 알림 강화:** DB 연결 상태를 지속적으로 확인하는 프로브를 추가하고, 실패 시 SRE 팀에 즉각 알림을 보내도록 설정합니다.
5. **서비스 분리:** 장기적으로는 인증·인가를 별도의 마이크로서비스로 분리하거나, 읽기 요청을 캐시/복제본 DB로 유도해 장애 전파를 최소화하는 구조를 고려합니다.

## 6. 향후 테스트 및 인증 자동화 제안

- **통합 테스트:** 테스트 단계에서 가상 PostgreSQL을 기동하고 Prisma로 실제 연결을 시도해 인증 과정을 검증합니다.
- **자격 증명 교체 검증:** 주기적으로 DB 비밀번호를 교체하고 애플리케이션 환경 변수도 갱신하는 자동화 작업을 통해 무중단 운영을 테스트합니다.
- **pg_hba 및 설정 검증 스크립트:** 배포 전에 애플리케이션 서버 IP가 pg_hba에 등록되어 있고 인증 방식이 올바른지 확인하는 검증 스크립트를 실행합니다.
- **엔드투엔드 모니터링:** 5분 간격 등으로 백엔드 API를 호출해 DB 쿼리 성공 여부를 확인하고, 실패 시 PagerDuty 등으로 알림을 보냅니다【19†L309-L318】.
- **개발자 교육:** Prisma와 PostgreSQL 환경에서 자주 발생하는 인증 문제와 해결법을 문서화하고 주기적으로 워크샵을 열어 실수 가능성을 줄입니다.

---

이 보고서는 GitHub의 `postgresql-authentication-issue.md` 문서를 기반으로 작업AI 엔지니어가 신속히 이해할 수 있도록 문제 원인, 영향, 해결 방안, 테스트 전략을 정리한 것입니다. 추후 DB 인증 문제를 예방하기 위해 제시된 개선 방안을 참고하여 개발 및 운영 환경에 적용하시기 바랍니다.
