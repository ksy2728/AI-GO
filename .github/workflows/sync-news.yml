name: Sync News Data

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 3ì‹œ, ì˜¤í›„ 9ì‹œ ì‹¤í–‰ (KST ê¸°ì¤€)
    - cron: '0 0,6,12 * * *'  # UTC ê¸°ì¤€ 0ì‹œ, 6ì‹œ, 12ì‹œ (KST +9ì‹œê°„)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches:
      - master
    paths:
      - 'scripts/sync-news.js'
      - '.github/workflows/sync-news.yml'

jobs:
  sync-news:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies (if needed)
        run: |
          # ë‰´ìŠ¤ ìˆ˜ì§‘ì€ Node.js ë‚´ì¥ ëª¨ë“ˆë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ì„¤ì¹˜ ë¶ˆí•„ìš”
          echo "News sync script uses only built-in Node.js modules"
          
      - name: Run news sync script
        run: |
          node scripts/sync-news.js
        env:
          NODE_ENV: production
          
      - name: Check for news changes
        id: check_news_changes
        run: |
          if git diff --quiet data/news-data.json; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected in news data"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in news data"
            git diff --stat data/news-data.json
            
            # ë‰´ìŠ¤ í†µê³„ ì¶”ì¶œ
            TOTAL_ARTICLES=$(jq -r '.totalArticles // (.articles | length)' data/news-data.json)
            TOTAL_SOURCES=$(jq -r '.sources | length // 0' data/news-data.json)
            CATEGORIES=$(jq -r '.categories | join(", ") // "various"' data/news-data.json)
            
            echo "ğŸ“Š Articles: ${TOTAL_ARTICLES} | Sources: ${TOTAL_SOURCES} | Categories: ${CATEGORIES}"
          fi
          
      - name: Commit and push news changes
        if: steps.check_news_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/news-data.json
          
          # ë‰´ìŠ¤ ë³€ê²½ ì‚¬í•­ ìš”ì•½ ìƒì„±
          TOTAL_ARTICLES=$(jq -r '.totalArticles // (.articles | length)' data/news-data.json)
          TOTAL_SOURCES=$(jq -r '.sources | length // 0' data/news-data.json)
          LATEST_ARTICLE=$(jq -r '.articles[0].title // "N/A"' data/news-data.json | head -c 50)
          
          git commit -m "feat: update AI news data [skip ci]" -m "ğŸ“° Articles: ${TOTAL_ARTICLES} | Sources: ${TOTAL_SOURCES}
          ğŸ†• Latest: ${LATEST_ARTICLE}...
          
          ğŸ¤– Automated news sync at $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ğŸ”„ Next sync: $(date -u -d '+8 hours' '+%Y-%m-%d %H:%M:%S UTC')"
          git push

      - name: News sync summary
        run: |
          if [[ "${{ steps.check_news_changes.outputs.changes }}" == "true" ]]; then
            echo "âœ… News data updated successfully!"
            TOTAL_ARTICLES=$(jq -r '.totalArticles // (.articles | length)' data/news-data.json)
            echo "ğŸ“Š Total articles: ${TOTAL_ARTICLES}"
            echo "ğŸ• Last updated: $(jq -r '.lastUpdated' data/news-data.json)"
          else
            echo "â„¹ï¸ News data is already up to date"
          fi