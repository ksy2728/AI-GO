name: Sync Artificial Analysis Data

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Fetch latest AA data
      env:
        NODE_ENV: production
      run: |
        echo "Fetching latest data from Artificial Analysis..."
        node scripts/fetch-aa-data.js

    - name: Check for changes
      id: changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Data changes detected"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No data changes"
        fi

    - name: Create Pull Request
      if: steps.changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'data: update AA models data (automated)'
        title: 'ğŸ¤– Update Artificial Analysis data'
        body: |
          ## Automated Data Update

          This PR contains the latest model data from Artificial Analysis.

          ### Changes
          - Updated model intelligence scores
          - Updated pricing information
          - Updated availability metrics
          - Updated performance benchmarks

          ### Data Sources
          - Artificial Analysis API
          - Provider health checks
          - Real-time status monitoring

          **Generated at:** ${{ github.event.head_commit.timestamp }}
          **Workflow:** ${{ github.workflow }}

          This PR was created automatically. Review the changes and merge when ready.
        branch: update-aa-data-${{ github.run_number }}
        delete-branch: true

    - name: Trigger Vercel Rebuild
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "Data updated. Vercel will rebuild automatically on merge."

    - name: Notify on success
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "âœ… Data sync completed successfully"
        echo "ğŸ“Š Updated models: $(jq '.models | length' src/data/aa-models.json)"
        echo "ğŸ”„ Pull request created for review"

    - name: Notify on no changes
      if: steps.changes.outputs.changes == 'false'
      run: |
        echo "â„¹ï¸ No data changes detected"
        echo "ğŸ“Š Current models: $(jq '.models | length' src/data/aa-models.json)"