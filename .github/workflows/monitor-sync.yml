name: Monitor API Sync Status

on:
  schedule:
    # 매 시간 정각에 실행
    - cron: '0 * * * *'
  workflow_dispatch: # 수동 실행 가능

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
  REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}

jobs:
  check-api-health:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run API health check
      id: health_check
      run: |
        node scripts/test-api-keys.js > api_status.txt 2>&1
        echo "::set-output name=status::$(cat api_status.txt)"
      continue-on-error: true

    - name: Check scraper status
      id: scraper_check
      run: |
        # AA 스크레이퍼 상태 확인
        curl -s https://raw.githubusercontent.com/ksy2728/AI-GO/master/public/data/aa-models.json | jq '.models | length' > aa_count.txt
        echo "AA models count: $(cat aa_count.txt)"
      continue-on-error: true

    - name: Send Slack notification on failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{
          \"text\": \"🚨 AI Server Monitor Alert\",
          \"attachments\": [{
            \"color\": \"danger\",
            \"title\": \"API/Scraper Health Check Failed\",
            \"fields\": [
              {\"title\": \"Workflow\", \"value\": \"${{ github.workflow }}\", \"short\": true},
              {\"title\": \"Run\", \"value\": \"${{ github.run_number }}\", \"short\": true},
              {\"title\": \"Time\", \"value\": \"$(date -u '+%Y-%m-%d %H:%M:%S UTC')\", \"short\": false}
            ],
            \"footer\": \"GitHub Actions\",
            \"footer_icon\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
          }]
        }" $SLACK_WEBHOOK_URL

    - name: Create issue on repeated failures
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'api-failure',
            state: 'open'
          });

          if (issues.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `🚨 API Health Check Failed - ${new Date().toISOString()}`,
              body: `## API Health Check Failed\n\n- Workflow run: #${{ github.run_number }}\n- Time: ${new Date().toISOString()}\n- Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['api-failure', 'automated']
            });
          }